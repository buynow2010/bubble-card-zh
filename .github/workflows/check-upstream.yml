name: æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 9 ç‚¹æ£€æŸ¥ (UTC 1:00)
    - cron: '0 1 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ä¸Šæ¸¸æœ€æ–° Release
        id: upstream
        run: |
          # è·å–åŸç‰ˆä»“åº“æœ€æ–° release tag
          LATEST=$(curl -s https://api.github.com/repos/Clooos/Bubble-Card/releases/latest | jq -r '.tag_name')
          echo "latest_tag=$LATEST" >> $GITHUB_OUTPUT
          echo "ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬: $LATEST"

      - name: è·å–å½“å‰æ±‰åŒ–ç‰ˆæœ¬
        id: current
        run: |
          # ä»å½“å‰ä»“åº“çš„æœ€æ–° tag æå–ç‰ˆæœ¬
          CURRENT=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          # æå–åŸºç¡€ç‰ˆæœ¬å· (å»æ‰ -zh åç¼€)
          BASE_VERSION=$(echo "$CURRENT" | sed 's/-zh$//')
          echo "current_tag=$CURRENT" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "å½“å‰æ±‰åŒ–ç‰ˆæœ¬: $CURRENT (åŸºäº $BASE_VERSION)"

      - name: å¯¹æ¯”ç‰ˆæœ¬
        id: compare
        run: |
          UPSTREAM="${{ steps.upstream.outputs.latest_tag }}"
          BASE="${{ steps.current.outputs.base_version }}"
          
          if [ "$UPSTREAM" != "$BASE" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "ğŸ”” å‘ç°æ–°ç‰ˆæœ¬! ä¸Šæ¸¸: $UPSTREAM, å½“å‰åŸºäº: $BASE"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          fi

      - name: åˆ›å»ºæ›´æ–°æé†’ Issue
        if: steps.compare.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const upstream = '${{ steps.upstream.outputs.latest_tag }}';
            const current = '${{ steps.current.outputs.current_tag }}';
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„ Issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ä¸Šæ¸¸æ›´æ–°'
            });
            
            const existingIssue = issues.data.find(i => i.title.includes(upstream));
            if (existingIssue) {
              console.log('å·²å­˜åœ¨ç›¸åŒç‰ˆæœ¬çš„ Issueï¼Œè·³è¿‡åˆ›å»º');
              return;
            }
            
            // åˆ›å»ºæ–° Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”„ ä¸Šæ¸¸æ›´æ–°: Bubble Card ${upstream}`,
              body: `## æ£€æµ‹åˆ° Bubble Card åŸç‰ˆæ›´æ–°\n\n` +
                    `| é¡¹ç›® | ç‰ˆæœ¬ |\n` +
                    `|------|------|\n` +
                    `| **ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬** | \`${upstream}\` |\n` +
                    `| **å½“å‰æ±‰åŒ–ç‰ˆæœ¬** | \`${current}\` |\n\n` +
                    `### åŸç‰ˆ Release\n` +
                    `ğŸ”— https://github.com/Clooos/Bubble-Card/releases/tag/${upstream}\n\n` +
                    `### ä¸‹ä¸€æ­¥\n` +
                    `1. æŸ¥çœ‹åŸç‰ˆæ›´æ–°å†…å®¹\n` +
                    `2. æ‹‰å–ä¸Šæ¸¸æ›´æ–°å¹¶æ±‰åŒ–\n` +
                    `3. å‘å¸ƒæ–°çš„æ±‰åŒ–ç‰ˆæœ¬\n\n` +
                    `---\n` +
                    `*æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`,
              labels: ['ä¸Šæ¸¸æ›´æ–°', 'å¾…å¤„ç†']
            });
            
            console.log('å·²åˆ›å»ºæ›´æ–°æé†’ Issue');
